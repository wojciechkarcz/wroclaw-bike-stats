<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wrocław Bike Stats — Daily Metrics</title>
    <style>
      :root {
        --bg: #0f1115;
        --panel: #151822;
        --ink: #e6e9ef;
        --muted: #9aa3b2;
        --accent: #7c9cff;
        --accent-2: #6bf2c7;
        --danger: #ff7b7b;
        --grid: #23283b;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--ink);
        background: radial-gradient(1200px 800px at 10% -10%, #18203a, transparent 40%),
                    radial-gradient(1200px 800px at 100% 0%, #1b1f2d, transparent 40%),
                    var(--bg);
      }

      header {
        padding: 24px 20px 8px;
        display: grid;
        gap: 10px;
      }
      .title {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        background: color-mix(in oklab, var(--panel) 90%, transparent);
        border: 1px solid var(--grid);
        border-radius: 12px;
        padding: 10px;
        margin: 6px 0 10px;
      }
      .controls > * { margin-right: 8px; }
      label { color: var(--muted); font-size: 12px; }
      input[type="date"], select, input[type="text"] {
        background: #0e1321;
        color: var(--ink);
        border: 1px solid var(--grid);
        border-radius: 10px;
        padding: 8px 10px;
      }
      button, .pill {
        background: #0e1321;
        color: var(--ink);
        border: 1px solid var(--grid);
        border-radius: 999px;
        padding: 8px 12px;
        cursor: pointer;
      }
      button:hover { border-color: #33406b; }

      main { padding: 0 20px 30px; }
      .grid {
        display: grid;
        gap: 12px;
      }
      @media (min-width: 900px) {
        .grid.cards { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        .grid.halves { grid-template-columns: 1.8fr 1.2fr; }
      }

      .card {
        background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 85%, transparent), var(--panel));
        border: 1px solid var(--grid);
        border-radius: 14px;
        padding: 14px;
        min-height: 64px;
      }
      .kpi-title { color: var(--muted); font-size: 12px; }
      .kpi-value { font-size: 20px; font-weight: 600; margin-top: 6px; }

      .chart-wrap { height: 220px; }
      .chart {
        position: relative;
        height: 100%;
        width: 100%;
        display: grid;
        grid-template-rows: 1fr 24px;
      }
      .bars {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        align-items: end;
        gap: 6px;
        padding: 10px 10px 2px 10px;
      }
      .bar {
        background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 35%, #2a3252), color-mix(in oklab, var(--accent) 55%, #1b2040));
        border-radius: 6px 6px 3px 3px;
        min-height: 2px;
      }
      .xlabels {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        gap: 6px;
        padding: 0 10px 8px 10px;
        color: var(--muted);
        font-size: 10px;
        letter-spacing: 0.2px;
      }

      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; border-bottom: 1px dashed #232739; padding: 8px 6px; }
      th { color: var(--muted); font-weight: 500; font-size: 12px; }
      tbody tr:hover { background: rgba(124, 156, 255, 0.06); }

      .muted { color: var(--muted); }
      .error { color: var(--danger); font-size: 13px; }
      .ok { color: var(--accent-2); }

      footer { padding: 16px 20px 28px; color: var(--muted); font-size: 12px; }
      a { color: var(--accent); text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <header>
      <div class="title">Wrocław Bike Stats — Daily Metrics</div>
      <div class="sub">Minimal viewer for yearly metrics JSON. Pick a date to explore KPIs, hourly rentals, busiest stations, and top routes.</div>
      <div class="controls">
        <div>
          <label for="date">Date</label><br />
          <input id="date" type="date" list="dates" />
          <datalist id="dates"></datalist>
        </div>
        <div>
          <label for="json-path">Data source</label><br />
          <input id="json-path" type="text" size="42" value="../data/processed/metrics/bikes-2025.json" />
        </div>
        <div>
          <button id="reload">Load</button>
        </div>
        <div class="muted" id="status"></div>
        <div style="margin-left:auto"></div>
        <div>
          <label for="file">or load local file</label><br />
          <input id="file" type="file" accept="application/json" />
        </div>
      </div>
    </header>

    <main>
      <div class="grid cards" id="kpis">
        <!-- KPI cards injected here -->
      </div>

      <div class="grid halves" style="margin-top:12px;">
        <div class="card chart-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div class="kpi-title">Bike rentals by hour</div>
            <div class="muted" id="max-hour"></div>
          </div>
          <div class="chart">
            <div class="bars" id="bars"></div>
            <div class="xlabels" id="xlabels"></div>
          </div>
        </div>

        <div class="card">
          <div class="kpi-title" style="margin-bottom:6px;">Busiest stations (Top 5)</div>
          <table>
            <thead>
              <tr>
                <th>Station</th>
                <th>Arrivals</th>
                <th>Departures</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="stations"></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="kpi-title" style="margin-bottom:6px;">Top routes (Top 5)</div>
        <table>
          <thead>
            <tr>
              <th>Start</th>
              <th>End</th>
              <th>Rides</th>
            </tr>
          </thead>
          <tbody id="routes"></tbody>
        </table>
      </div>
    </main>

    <footer>
      Data: yearly metrics JSON produced by compute_daily_metrics.py. If fetch fails (e.g., file:// context), use “load local file”.
    </footer>

    <script>
      const el = (sel) => document.querySelector(sel);
      const els = (sel) => Array.from(document.querySelectorAll(sel));

      function fmtNum(n, digits=0) {
        if (n === null || n === undefined) return '—';
        return Number(n).toLocaleString(undefined, { maximumFractionDigits: digits });
      }

      function percentile(values, p) {
        if (!values.length) return 0;
        const a = [...values].sort((x,y)=>x-y);
        const idx = Math.min(a.length-1, Math.max(0, Math.floor(p*(a.length-1))));
        return a[idx];
      }

      function renderKpis(day, dateStr) {
        const k = [
          { t: 'Total rides', v: fmtNum(day.total_rides) },
          { t: 'Avg distance (km)', v: fmtNum(day.avg_distance_km, 3) },
          { t: 'Avg duration (min)', v: fmtNum(day.avg_duration_min, 2) },
          { t: 'Total distance (km)', v: fmtNum(day.total_distance_km, 1) },
          { t: 'Total duration (min)', v: fmtNum(day.total_duration_min) },
          { t: 'Round trips', v: fmtNum(day.round_trips) },
          { t: 'Left outside station', v: fmtNum(day.left_outside_station) },
        ];
        const wrap = el('#kpis');
        wrap.innerHTML = '';
        k.forEach(item => {
          const d = document.createElement('div');
          d.className = 'card';
          d.innerHTML = `<div class="kpi-title">${item.t}</div><div class="kpi-value">${item.v}</div>`;
          wrap.appendChild(d);
        });
      }

      function renderHistogram(day) {
        const bars = el('#bars');
        const xlabels = el('#xlabels');
        bars.innerHTML = '';
        xlabels.innerHTML = '';
        const hist = day.bike_rentals_histogram || {};
        const values = Array.from({length: 24}, (_,h)=> Number(hist[String(h)] || 0));
        const max = Math.max(1, ...values);
        const maxHour = values.indexOf(max);
        el('#max-hour').textContent = `Peak: ${max} rides at ${String(maxHour).padStart(2,'0')}:00`;
        for (let h=0; h<24; h++) {
          const v = values[h];
          const b = document.createElement('div');
          b.className = 'bar';
          b.style.height = `${(v/max)*100}%`;
          b.title = `${String(h).padStart(2,'0')}:00 — ${v}`;
          bars.appendChild(b);
          const lbl = document.createElement('div');
          lbl.textContent = (h%3===0) ? String(h) : '';
          xlabels.appendChild(lbl);
        }
      }

      function renderStations(day) {
        const body = el('#stations');
        body.innerHTML = '';
        (day.busiest_stations_top5 || []).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.station ?? '—'}</td><td>${fmtNum(r.arrivals)}</td><td>${fmtNum(r.departures)}</td><td><b>${fmtNum(r.total)}</b></td>`;
          body.appendChild(tr);
        });
      }

      function renderRoutes(day) {
        const body = el('#routes');
        body.innerHTML = '';
        (day.top_routes_top5 || []).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.start_station ?? '—'}</td><td>${r.end_station ?? '—'}</td><td><b>${fmtNum(r.rides)}</b></td>`;
          body.appendChild(tr);
        });
      }

      function updateDatePicker(daysMap) {
        const ds = Object.keys(daysMap).sort();
        const dl = el('#dates');
        dl.innerHTML = '';
        ds.forEach(d => {
          const o = document.createElement('option');
          o.value = d;
          dl.appendChild(o);
        });
        // Set min/max if possible
        const inp = el('#date');
        if (ds.length) {
          inp.min = ds[0];
          inp.max = ds[ds.length-1];
          inp.value = ds[ds.length-1];
        }
      }

      function renderDay(payload, dateStr) {
        if (!payload) {
          el('#status').innerHTML = `<span class="error">No data for ${dateStr}</span>`;
          return;
        }
        el('#status').textContent = '';
        renderKpis(payload, dateStr);
        renderHistogram(payload);
        renderStations(payload);
        renderRoutes(payload);
      }

      async function loadFromPath(path) {
        el('#status').textContent = 'Loading…';
        try {
          const res = await fetch(path, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          el('#status').innerHTML = `<span class="ok">Loaded ${path}</span>`;
          return data;
        } catch (e) {
          el('#status').innerHTML = `<span class="error">Failed to fetch ${path}. You can select a local file below.</span>`;
          return null;
        }
      }

      function hookFileLoader() {
        const fi = el('#file');
        fi.addEventListener('change', async (e) => {
          const f = fi.files?.[0];
          if (!f) return;
          try {
            const text = await f.text();
            const data = JSON.parse(text);
            bootstrap(data);
            el('#status').innerHTML = `<span class="ok">Loaded local file: ${f.name}</span>`;
          } catch (err) {
            el('#status').innerHTML = `<span class="error">Invalid JSON file.</span>`;
          }
        });
      }

      let CURRENT = { year: null, days: {} };

      function bootstrap(data) {
        if (!data || !data.days) {
          el('#status').innerHTML = `<span class="error">Invalid JSON structure. Expecting { year, days }.</span>`;
          return;
        }
        CURRENT = data;
        updateDatePicker(CURRENT.days);
        // Render last date if present
        const keys = Object.keys(CURRENT.days).sort();
        if (keys.length) {
          const last = keys[keys.length-1];
          el('#date').value = last;
          renderDay(CURRENT.days[last], last);
        }
      }

      async function init() {
        hookFileLoader();
        // Default load
        const defaultPath = el('#json-path').value;
        const data = await loadFromPath(defaultPath);
        if (data) bootstrap(data);

        el('#reload').addEventListener('click', async () => {
          const path = el('#json-path').value.trim();
          const d = await loadFromPath(path);
          if (d) bootstrap(d);
        });

        el('#date').addEventListener('change', (e) => {
          const v = e.target.value;
          if (!v) return;
          const payload = CURRENT.days?.[v];
          renderDay(payload, v);
        });
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
  </html>

